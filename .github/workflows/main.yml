name: Build FFmpeg with H.265 and Release

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: "Build untuk Linux (true/false)"
        type: boolean
        default: true
      build_windows:
        description: "Build untuk Windows (true/false)"
        type: boolean
        default: true
      release_tag:
        description: "Tag untuk release (contoh: v1.0.0)"
        type: string
        required: true

jobs:
  build:
    strategy:
      matrix:
        os: ${{ fromJSON( needs.setup.outputs.matrix ) }}
    runs-on: ${{ matrix.os }}
    needs: setup
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # Install dependencies untuk Linux
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          cmake \
          git \
          libtool \
          pkg-config \
          yasm \
          nasm \
          libx264-dev \
          libx265-dev \
          libnuma-dev \
          libvpx-dev \
          libfdk-aac-dev \
          libmp3lame-dev \
          libopus-dev
    
    # Install dependencies untuk Windows
    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install -y --no-progress \
          git \
          cmake \
          yasm \
          nasm \
          msys2
        
    - name: Clone FFmpeg
      run: |
        git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg
        cd ffmpeg
    
    # Build untuk Linux
    - name: Build FFmpeg (Linux)
      if: runner.os == 'Linux'
      run: |
        cd ffmpeg
        ./configure \
          --enable-gpl \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libvpx \
          --enable-libfdk-aac \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-nonfree
        make -j$(nproc)
        sudo make install
    
    # Build untuk Windows
    - name: Build FFmpeg (Windows)
      if: runner.os == 'Windows'
      run: |
        cd ffmpeg
        ./configure \
          --toolchain=msvc \
          --enable-gpl \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libvpx \
          --enable-libfdk-aac \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-nonfree
        make -j$(nproc)
        make install
    
    - name: Verify FFmpeg build
      run: |
        ffmpeg -version
        ffmpeg -codecs | grep hevc
        ffmpeg -codecs | grep h265
    
    # Package untuk Linux
    - name: Package Linux binaries
      if: runner.os == 'Linux'
      run: |
        mkdir -p ffmpeg_build
        cp /usr/local/bin/ffmpeg ffmpeg_build/
        cp /usr/local/bin/ffprobe ffmpeg_build/
        cp /usr/local/bin/ffplay ffmpeg_build/ || true
        tar -czvf ffmpeg_h265_linux.tar.gz ffmpeg_build/*
    
    # Package untuk Windows
    - name: Package Windows binaries
      if: runner.os == 'Windows'
      run: |
        mkdir ffmpeg_build
        copy ffmpeg\ffmpeg.exe ffmpeg_build\
        copy ffmpeg\ffprobe.exe ffmpeg_build\
        copy ffmpeg\ffplay.exe ffmpeg_build\ || echo "FFplay tidak tersedia"
        7z a ffmpeg_h265_windows.zip ffmpeg_build\*
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg_h265_${{ runner.os }}
        path: |
          ${{ runner.os == 'Linux' && 'ffmpeg_h265_linux.tar.gz' || 'ffmpeg_h265_windows.zip' }}

  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Setup build matrix
        id: set-matrix
        run: |
          matrix=[]
          if ${{ github.event.inputs.build_linux == 'true' }}; then
            matrix+=("ubuntu-latest")
          fi
          if ${{ github.event.inputs.build_windows == 'true' }}; then
            matrix+=("windows-latest")
          fi
          echo "matrix=${matrix}" | tee -a $GITHUB_OUTPUT
          echo "matrix=${matrix}"

  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: FFmpeg with H.265 Build ${{ github.event.inputs.release_tag }}
          body: |
            FFmpeg dengan dukungan H.265/HEVC
            Dibangun untuk: ${{ github.event.inputs.build_linux && 'Linux' }} ${{ github.event.inputs.build_windows && 'Windows' }}
          files: |
            artifacts/ffmpeg_h265_linux/ffmpeg_h265_linux.tar.gz
            artifacts/ffmpeg_h265_windows/ffmpeg_h265_windows.zip
          draft: false
          prerelease: false
