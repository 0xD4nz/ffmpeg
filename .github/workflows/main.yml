name: Build Static FFmpeg for Linux and Windows with Release Upload

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  RELEASE_TAG: ffmpeg-static-restream-build

jobs:
  build-linux-static:
    name: Build Static FFmpeg on Linux (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake build-essential cmake git libtool \
            pkg-config texinfo wget yasm nasm zlib1g-dev libssl-dev

      - name: Build x264 (static)
        run: |
          git clone --depth 1 https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --prefix="$HOME/ffmpeg_build" --enable-static --disable-opencl
          make -j$(nproc)
          make install

      - name: Build x265 (static)
        run: |
          git clone https://bitbucket.org/multicoreware/x265_git.git
          cd x265_git/source
          mkdir -p build-linux-static
          cd build-linux-static
          cmake -G "Unix Makefiles" \
            -DCMAKE_INSTALL_PREFIX="$HOME/ffmpeg_build" \
            -DENABLE_SHARED=off \
            -DENABLE_CLI=off \
            -DEXPORT_PKG_CONFIG=ON \
            ..
          make -j$(nproc)
          make install
          # Copy x265.pc jika ada
          find . -name 'x265.pc' -exec cp {} $HOME/ffmpeg_build/lib/pkgconfig/ \; || true

      
      - name: Generate x265.pc if not exist
        run: |-
          if [ ! -f "$HOME/ffmpeg_build/lib/pkgconfig/x265.pc" ]; then
            echo "Download x265.pc.in dari upstream dan convert jadi x265.pc"
            wget -O /tmp/x265.pc.in https://github.com/videolan/x265/raw/refs/heads/master/source/x265.pc.in
            sed \
              -e 's|@PREFIX@|'"$HOME"'/ffmpeg_build|g' \
              -e 's|@LIBDIR@|'"$HOME"'/ffmpeg_build/lib|g' \
              -e 's|@INCLUDEDIR@|'"$HOME"'/ffmpeg_build/include|g' \
              -e 's|@X265_VERSION@|3.5|g' \
              /tmp/x265.pc.in > $HOME/ffmpeg_build/lib/pkgconfig/x265.pc
          fi
          echo "DEBUG: List $HOME/ffmpeg_build/lib/pkgconfig"
          ls -lh $HOME/ffmpeg_build/lib/pkgconfig
          echo "DEBUG: Content of x265.pc"
          cat $HOME/ffmpeg_build/lib/pkgconfig/x265.pc
      - name: Build fdk-aac (static)
        run: |
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
          cd fdk-aac
          autoreconf -fiv
          ./configure --prefix="$HOME/ffmpeg_build" --disable-shared
          make -j$(nproc)
          make install

      - name: Build FFmpeg (static, master branch)
        run: |
          export PKG_CONFIG_PATH="$HOME/ffmpeg_build/lib/pkgconfig"
          pkg-config --modversion x265 || echo "x265.pc NOT FOUND"
          git clone https://github.com/ffmpeg/ffmpeg.git
          cd ffmpeg
          ./configure \
            --prefix="$HOME/ffmpeg_build" \
            --pkg-config-flags="--static" \
            --extra-cflags="-I$HOME/ffmpeg_build/include" \
            --extra-ldflags="-L$HOME/ffmpeg_build/lib -static" \
            --extra-libs="-lpthread -lm" \
            --bindir="$HOME/bin" \
            --enable-gpl \
            --enable-openssl \
            --enable-nonfree \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libfdk-aac \
            --enable-protocol=http \
            --enable-protocol=https \
            --enable-protocol=rtmp \
            --enable-muxer=flv \
            --enable-demuxer=flv \
            --enable-decoder=hevc \
            --enable-encoder=libx265 \
            --disable-shared \
            --enable-static \
            --disable-debug \
            --disable-doc \
            --enable-small
          make -j$(nproc)
          make install
          cp $HOME/bin/ffmpeg $GITHUB_WORKSPACE/ffmpeg-linux-static-x86_64

      - name: Upload as Artifact (Linux Static)
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-static
          path: ${{ github.workspace }}/ffmpeg-linux-static-x86_64

      - name: Upload to GitHub Release (Linux Static)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "FFmpeg Static Restream Build"
          files: ${{ github.workspace }}/ffmpeg-linux-static-x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-static:
    name: Build Static FFmpeg on Windows (MSYS2)
    runs-on: windows-latest

    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            git make yasm nasm autoconf automake libtool
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-libtool
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-cmake
            base-devel

      - name: Build x264 (static)
        shell: msys2 {0}
        run: |
          git clone --depth 1 https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --prefix=$HOME/static --enable-static --disable-opencl --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install
          cd ..

      - name: Build x265 (static)
        shell: msys2 {0}
        run: |
          git clone https://bitbucket.org/multicoreware/x265_git.git
          cd x265_git/source
          mkdir -p build-win64-static
          cd build-win64-static
          cmake -G "MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$HOME/static -DENABLE_SHARED=off -DENABLE_CLI=off -DEXPORT_PKG_CONFIG=ON ..
          make -j$(nproc)
          make install
          find . -name 'x265.pc' -exec cp {} $HOME/static/lib/pkgconfig/ \;

      - name: Build fdk-aac (static)
        shell: msys2 {0}
        run: |
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
          cd fdk-aac
          autoreconf -fiv
          ./configure --prefix=$HOME/static --disable-shared --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install

      - name: Build FFmpeg (static, master branch, fully static binary)
        shell: msys2 {0}
        run: |
          export PKG_CONFIG_PATH="$HOME/static/lib/pkgconfig"
          pkg-config --modversion x265 || echo "x265.pc NOT FOUND"
          git clone https://github.com/ffmpeg/ffmpeg.git
          cd ffmpeg
          ./configure \
            --prefix="$HOME/static" \
            --pkg-config-flags="--static" \
            --extra-cflags="-I$HOME/static/include" \
            --extra-ldflags="-L$HOME/static/lib -static -static-libgcc -static-libstdc++" \
            --extra-libs="-lpthread -lm" \
            --target-os=mingw32 \
            --arch=x86_64 \
            --enable-gpl \
            --enable-openssl \
            --enable-nonfree \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libfdk-aac \
            --enable-protocol=http \
            --enable-protocol=https \
            --enable-protocol=rtmp \
            --enable-muxer=flv \
            --enable-demuxer=flv \
            --enable-decoder=hevc \
            --enable-encoder=libx265 \
            --disable-shared \
            --enable-static \
            --disable-debug \
            --disable-doc \
            --enable-small
          make -j$(nproc)
          make install
          cp $HOME/static/bin/ffmpeg.exe $GITHUB_WORKSPACE/ffmpeg-windows-static-x86_64.exe

      - name: Upload as Artifact (Windows Static)
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-static
          path: ${{ github.workspace }}/ffmpeg-windows-static-x86_64.exe

      - name: Upload to GitHub Release (Windows Static)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "FFmpeg Static Restream Build"
          files: ${{ github.workspace }}/ffmpeg-windows-static-x86_64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
